#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

logger -p user.notice -t "slugc[$$]" "nnginx_build_pack nginx_install_start"

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

LOGGER_FLAGS=""

#create the dirs if needed
mkdir -p $CACHE_DIR
mkdir -p $BUILD_DIR

# Default nginx install from our dist is in ./nginx-dist/usr/local/nginx

NGINX_CACHE_DIR=$CACHE_DIR/nginx-dist/usr/local/nginx

if [ ! -d $NGINX_CACHE_DIR ]
then
	( cd $CACHE_DIR && 
	  curl --silent --location https://s3-eu-west-1.amazonaws.com/ray-s3-test/nginx/nginx-1.4.4-pagespeed-1.7.30.tgz |
	  tar xf - )
fi

cp -R $NGINX_CACHE_DIR $BUILD_DIR

NGINX_BASE_DIR=$BUILD_DIR/nginx-dist/usr/local/nginx

BUILD_SCRIPT="$BUILD_DIR/.profile.d/nginx.sh"
mkdir -p $(dirname $BUILD_SCRIPT)
echo 'export PATH="$NGINX_BASE_DIR/bin:$PATH"' >> $BUILD_SCRIPT

logger -p user.notice -t "slugc[$$]" "nnginx_build_pack nginx_install_end $LOGGER_FLAGS"
