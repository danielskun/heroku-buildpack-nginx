#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

NGINX_VERSION=1.4.4
PCRE_VERSION=8.21
PAGESPEED_VERSION=1.7.30.4-beta

nginx_tarball_url=http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
pcre_tarball_url=http://garr.dl.sourceforge.net/project/pcre/pcre/${PCRE_VERSION}/pcre-${PCRE_VERSION}.tar.bz2
ps_tarball_url=https://s3-eu-west-1.amazonaws.com/ray-s3-test/nginx/ngx_pagespeed-release-${PAGESPEED_VERSION}.tgz

logger -p user.notice -t "slugc[$$]" "nginx_build_pack nginx_install_start"

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

ROOT_DIR=$(cd ${BIN_DIR} && cd .. ; pwd) # absolute path

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

LOGGER_FLAGS=""

#create the dirs if needed
mkdir -p ${CACHE_DIR}

mkdir -p ${BUILD_DIR}

# Default nginx install from our dist is in ./nginx-dist/usr/local/nginx

NGINX_CACHE_DIR=${CACHE_DIR}/nginx-${NGINX_VERSION}

rm -rf ${NGINX_CACHE_DIR} # TODO: remove this one build is stable

mkdir -p ${CACHE_DIR} # TODO: remove this one build is stable

NGINX_DIST_DIR=${CACHE_DIR}/dist/nginx

mkdir -p ${NGINX_DIST_DIR} # TODO: check if this is needed, make will probably create it without help

if [ ! -d ${NGINX_CACHE_DIR} ]
then

(
	cd ${CACHE_DIR}

# TODO build PS on Heroku

	echo "Downloading $ps_tarball_url" # expanded into a new directory (ngx_pagespeed-release-${PAGESPEED_VERSION})
	curl --silent -L ${ps_tarball_url} | tar xz

	echo "Downloading $nginx_tarball_url" # expanded into a new directory (nginx-${NGINX_VERSION})
	curl --silent -L ${nginx_tarball_url} | tar xz

	cd nginx-${NGINX_VERSION}

	echo "Downloading $pcre_tarball_url"
	curl --silent -L ${pcre_tarball_url} | tar xj

	echo "Running configure for NGINX"
	./configure \
		--with-pcre=pcre-${PCRE_VERSION} \
		--prefix=${NGINX_DIST_DIR} \
		--add-module=../ngx_pagespeed-release-${PAGESPEED_VERSION} > /dev/null

	echo "Building NGINX"
	make > /dev/null

	echo "Installing NGINX"
	make install # TODO: clean out this DEBUG which shows where the install is
)

fi

cp -R ${NGINX_DIST_DIR} ${BUILD_DIR}

cp -R ${ROOT_DIR}/config ${BUILD_DIR}/config

cp ${ROOT_DIR}/scripts/start-nginx.sh ${BUILD_DIR}

chmod +x ${BUILD_DIR}/*.sh

BUILD_TARGET="$BUILD_DIR/.profile.d/nginx.sh"
mkdir -p $(dirname ${BUILD_TARGET})
echo "export NGINX_VERSION=nginx-${NGINX_VERSION}" > ${BUILD_TARGET} # double quoutes to allow expansion in this shell
echo 'export NGINX_BASE_DIR=~/${NGINX_VERSION}' >> ${BUILD_TARGET} # single quote to expand this one at deployment time
echo 'export PATH="$NGINX_BASE_DIR/sbin:$PATH"' >> ${BUILD_TARGET} # likewise expand this setting at deployment time

logger -p user.notice -t "slugc[$$]" "nginx_build_pack nginx_install_end $LOGGER_FLAGS"